{% extends 'base.html' %}

{% block title %}{{ tool.get_name_display }}{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb small">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Infrastructure</a></li>
            <li class="breadcrumb-item active">{{ tool.get_name_display }}</li>
        </ol>
    </nav>

    <div class="d-flex align-items-center">
        <div class="border rounded-3 me-3 d-flex align-items-center justify-content-center shadow-sm" style="background-color: var(--icon-box); width: 64px !important; height: 64px !important; flex-shrink: 0;">
            {% if tool.get_custom_icon_svg %}
                <div style="width: 32px; height: 32px; fill: var(--text-main); display: flex; align-items: center; justify-content: center;">
                    {{ tool.get_custom_icon_svg|safe }}
                </div>
            {% else %}
                <i class="si si-{{ tool.get_icon_class }} fs-3" style="color: var(--text-main);"></i>
            {% endif %}
        </div>
        <div>
            <h1 class="h3 fw-bold mb-0">{{ tool.get_name_display }}</h1>
            <span class="text-muted small">Service Management & Resource Control</span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="row mb-4 g-3">
            <div class="col-md-auto d-flex" style="min-width: 400px; flex: 1;">
                <div class="card shadow-sm border-0 w-100">
                    <div class="card-body p-4 d-flex flex-column">
                        {% include 'core/partials/tool_status.html' %}
                    </div>
                </div>
            </div>
            <div class="col-md-auto">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4 d-flex flex-column" style="min-width: 300px; height: auto;">
                        {% if tool.status == 'installed' %}
                        <h6 class="fw-bold mb-3">Service Management</h6>
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-2"><i class="bi bi-play-fill"></i> Start</button>
                                <button class="btn btn-outline-warning btn-sm d-flex align-items-center gap-2"><i class="bi bi-pause-fill"></i> Stop</button>
                                <button class="btn btn-outline-danger btn-sm d-flex align-items-center gap-2"><i class="bi bi-arrow-clockwise"></i> Restart</button>
                                
                                {% load core_tags %}
                                {% call_method module "get_logs_url" tool as logs_url %}
                                {% if logs_url %}
                                <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                                        onclick="openLogs('{{ logs_url }}')">
                                    <i class="bi bi-file-text"></i> Service Logs
                                </button>
                                {% endif %}
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                {% call_method module "get_extra_actions_template_name" as extra_actions_template %}
                                {% if extra_actions_template %}
                                    {% include extra_actions_template %}
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <h6 class="fw-bold mb-3 text-muted">Service Management</h6>
                        <div class="mt-auto">
                            <span class="text-muted small">Service management available after installation</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if resource_tabs and tool.status == 'installed' %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                {% call_method module "get_resource_header_template_name" as resource_header_template %}
                {% if resource_header_template %}
                    {% include resource_header_template %}
                {% endif %}
                
                <ul class="nav nav-tabs card-header-tabs" id="resourceTabs" role="tablist">
                    {% for tab in resource_tabs %}
                    <li class="nav-item">
                        <button class="nav-link {% if forloop.first %}active{% endif %} fw-bold" 
                                data-bs-toggle="tab" 
                                data-bs-target="#{{ tab.id }}" 
                                type="button"
                                {% if tab.hx_get %}
                                hx-get="{{ tab.hx_get }}" 
                                hx-target="#{{ tab.id }}" 
                                hx-trigger="click"
                                {% endif %}>
                            {{ tab.label }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-body p-4">
                <div class="tab-content">
                    {% for tab in resource_tabs %}
                    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                         id="{{ tab.id }}"
                         {% if tab.hx_auto_refresh %}
                         hx-get="{{ tab.hx_get }}" 
                         hx-trigger="{{ tab.hx_auto_refresh }}" 
                         hx-swap="innerHTML"
                         {% endif %}>
                        {% if tab.template %}
                            {% include tab.template %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Shared Modals -->

<div class="modal fade" id="describeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="describeTitle">Description</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <pre id="describeContent" class="text-light p-3 small mb-0" style="height: 600px; overflow-y: auto; white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="yamlModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="yamlModalTitle">Edit YAML</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="yamlEditor" style="height: 600px; width: 100%;"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveYaml()">Save</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% call_method module "get_extra_content_template_name" as extra_content_template %}
{% if extra_content_template %}
    {% include extra_content_template %}
{% endif %}

<script>
    function openTerminal(wsPath, id, name) {
        if (typeof addTerminalTab === 'function') {
            addTerminalTab(id, name, wsPath);
        } else {
            console.error('addTerminalTab not found');
        }
    }

    // Handle auto-refresh toggle logic if needed via HTMX events
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.target.id === 'logContent') {
            var autoRefresh = document.getElementById('logAutoRefresh');
            if (autoRefresh && !autoRefresh.checked && evt.detail.trigger !== 'refreshLogs') {
                evt.preventDefault();
            }
        }
    });
</script>
{% endblock %}
