{% extends 'base.html' %}

{% block title %}{{ tool.get_name_display }}{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb small">
            <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Infrastructure</a></li>
            <li class="breadcrumb-item active">{{ tool.get_name_display }}</li>
        </ol>
    </nav>

    <script>
        function filterByNamespace(ns) {
            var url = new URL(window.location.href);
            if (ns) url.searchParams.set('namespace', ns);
            else url.searchParams.delete('namespace');
            window.location.href = url.toString();
        }

        function openDescribe(type, ns, name) {
            document.getElementById('describeTitle').innerText = 'Describe ' + type + ': ' + name;
            document.getElementById('describeContent').innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-light"></div></div>';
            var modal = new bootstrap.Modal(document.getElementById('describeModal'));
            modal.show();
            
            var url = '/k8s/resource/describe/' + type + '/';
            if (ns) {
                url += ns + '/' + name + '/';
            } else {
                url += name + '/';
            }
            
            fetch(url)
                .then(function(r) { return r.text(); })
                .then(function(data) {
                    document.getElementById('describeContent').innerText = data;
                });
        }
    </script>
    <div class="d-flex align-items-center">
        <div class="border rounded-3 me-3 d-flex align-items-center justify-content-center shadow-sm" style="background-color: var(--icon-box); width: 64px !important; height: 64px !important; flex-shrink: 0;">
            <i class="si si-{{ tool.get_icon_class }} fs-3" style="color: var(--text-main);"></i>
        </div>
        <div>
            <h1 class="h3 fw-bold mb-0">{{ tool.get_name_display }}</h1>
            <span class="text-muted small">Service Management & Resource Control</span>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="row mb-4 g-3">
            <div class="col-md-auto d-flex" style="min-width: 400px; flex: 1;">
                <div class="card shadow-sm border-0 w-100">
                    <div class="card-body p-4 d-flex flex-column">
                        {% include 'core/partials/tool_status.html' %}
                    </div>
                </div>
            </div>
            <div class="col-md-auto">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4 d-flex flex-column" style="min-width: 300px; height: auto;">
                        {% if tool.status == 'installed' %}
                        <h6 class="fw-bold mb-3">Service Management</h6>
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-2"><i class="bi bi-play-fill"></i> Start</button>
                                <button class="btn btn-outline-warning btn-sm d-flex align-items-center gap-2"><i class="bi bi-pause-fill"></i> Stop</button>
                                <button class="btn btn-outline-danger btn-sm d-flex align-items-center gap-2"><i class="bi bi-arrow-clockwise"></i> Restart</button>
                                
                                {% load core_tags %}
                                {% call_method module "get_logs_url" tool as logs_url %}
                                {% if logs_url %}
                                <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2"
                                        onclick="openLogs('{{ logs_url }}')">
                                    <i class="bi bi-file-text"></i> Service Logs
                                </button>
                                {% endif %}
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                {% call_method module "get_extra_actions_template_name" as extra_actions_template %}
                                {% if extra_actions_template %}
                                    {% include extra_actions_template %}
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <h6 class="fw-bold mb-3 text-muted">Service Management</h6>
                        <div class="mt-auto">
                            <span class="text-muted small">Service management available after installation</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if resource_tabs %}
        <div class="card shadow-sm border-0">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                {% call_method module "get_resource_header_template_name" as resource_header_template %}
                {% if resource_header_template %}
                    {% include resource_header_template %}
                {% endif %}
                
                <ul class="nav nav-tabs card-header-tabs" id="resourceTabs" role="tablist">
                    {% for tab in resource_tabs %}
                    <li class="nav-item">
                        <button class="nav-link {% if forloop.first %}active{% endif %} fw-bold" 
                                data-bs-toggle="tab" 
                                data-bs-target="#{{ tab.id }}" 
                                type="button"
                                {% if tab.hx_get %}
                                hx-get="{{ tab.hx_get }}" 
                                hx-target="#{{ tab.id }}" 
                                hx-trigger="click"
                                {% endif %}>
                            {{ tab.label }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="card-body p-4">
                <div class="tab-content">
                    {% for tab in resource_tabs %}
                    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                         id="{{ tab.id }}"
                         {% if tab.hx_auto_refresh %}
                         hx-get="{{ tab.hx_get }}" 
                         hx-trigger="{{ tab.hx_auto_refresh }}" 
                         hx-swap="innerHTML"
                         {% endif %}>
                        {% if tab.template %}
                            {% include tab.template %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Shared Modals -->

<div class="modal fade" id="describeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="describeTitle">Description</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <pre id="describeContent" class="text-light p-3 small mb-0" style="height: 600px; overflow-y: auto; white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="yamlModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white" id="yamlModalTitle">Edit YAML</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="yamlEditor" style="height: 600px; width: 100%;"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveYaml()">Save</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function openTerminal(type, id, name) {
        var wsPath = '';
        if (type === 'docker') {
            wsPath = 'ws/docker/shell/' + id + '/';
        } else {
            wsPath = 'ws/k8s/shell/' + id + '/';
        }
        if (typeof addTerminalTab === 'function') {
            addTerminalTab(id, name, wsPath);
        } else {
            console.error('addTerminalTab not found');
        }
    }



    function openPodLogs(ns, name) {
        openLogs('/k8s/pod/' + ns + '/' + name + '/logs/');
    }

    function openPodShell(ns, name) {
        openTerminal('k8s', ns + '/' + name, name);
    }

    function openDockerShell(id, name) {
        openTerminal('docker', id, name);
    }

    var currentYamlContext = {};
    var aceEditor;
    function openYamlEditor(type, namespace, name) {
        currentYamlContext = { type: type, namespace: namespace, name: name };
        fetch('/k8s/resource/yaml/' + type + '/' + namespace + '/' + name + '/')
            .then(function(r) { return r.text(); })
            .then(function(yaml) {
                if (!aceEditor) {
                    aceEditor = ace.edit("yamlEditor");
                    aceEditor.setTheme("ace/theme/monokai");
                    aceEditor.session.setMode("ace/mode/yaml");
                }
                aceEditor.setValue(yaml, -1);
                new bootstrap.Modal(document.getElementById('yamlModal')).show();
            });
    }

    function saveYaml() {
        var ctx = currentYamlContext;
        var formData = new FormData();
        formData.append('yaml', aceEditor.getValue());
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        fetch('/k8s/resource/yaml/' + ctx.type + '/' + ctx.namespace + '/' + ctx.name + '/', { method: 'POST', body: formData })
            .then(function(r) { if (r.ok) location.reload(); else r.text().then(alert); });
    }

    // Handle auto-refresh toggle logic if needed via HTMX events
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.target.id === 'logContent') {
            var autoRefresh = document.getElementById('logAutoRefresh');
            if (autoRefresh && !autoRefresh.checked && evt.detail.trigger !== 'refreshLogs') {
                evt.preventDefault();
            }
        }
    });
</script>

<div class="modal fade" id="changeJenkinsPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Change Jenkins Admin Password</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'change_jenkins_admin_password' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-light">New Password</label>
                        <input type="password" name="new_password" class="form-control bg-dark text-light border-secondary" required>
                        <div class="form-text text-muted">This will update the password for the '{{ tool.config_data.username|default:'admin' }}' user and save it in SolsticeOps.</div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
